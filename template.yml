Resources:
  AppNode:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0f39d06d145e9bb63
      KeyName: Influx20
      SecurityGroups:
        - !Ref AppNodeSG
      UserData: !Base64 >
        #!/bin/bash

        apt-get update -qq

        curl -fsSL https://get.docker.com -o get-docker.sh

        sh get-docker.sh

        COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
        sh -c "curl -L https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose"
        chmod +x /usr/local/bin/docker-compose
        sh -c "curl -L https://raw.githubusercontent.com/docker/compose/${COMPOSE_VERSION}/contrib/completion/bash/docker-compose > /etc/bash_completion.d/docker-compose"
        docker-compose -v

        cd /

        git clone https://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@github.com/cypernex/smartsite.git

        chmod -R 777 /smartsite

        cd /smartsite

        curl -H 'Authorization: token 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' -o docker-compose.yml https://raw.githubusercontent.com/cypernex/docker-compose/master/tingstack.yml

        docker-compose up 
  AppNodeSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: for the app nodes that allow ssh
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '8086'
          ToPort: '8086'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '3000'
          ToPort: '3000'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '1880'
          ToPort: '1880'
          CidrIp: 0.0.0.0/0

